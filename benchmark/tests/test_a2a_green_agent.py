"""A2A Green agent tests.

Tests cover:
- Config parsing and validation
- Safe type conversions
"""

from __future__ import annotations

import json
from pathlib import Path
from unittest.mock import MagicMock, patch

import pytest

from smi_bench.a2a_green_agent import (
    EvalConfig,
    _load_cfg,
    _safe_int,
    _safe_float,
)


def test_load_cfg_valid_dict_returns_evalconfig() -> None:
    """Config parsing returns EvalConfig for valid input."""
    raw = {
        "corpus_root": "/corpus",
        "package_ids_file": "/manifest.txt",
        "samples": 10,
        "rpc_url": "https://test.rpc",
        "simulation_mode": "dry-run",
        "per_package_timeout_seconds": 90.0,
        "max_plan_attempts": 5,
        "continue_on_error": True,
        "resume": False,
        "run_id": "test-run",
    }

    config = _load_cfg(raw)

    assert config.corpus_root == "/corpus"
    assert config.package_ids_file == "/manifest.txt"
    assert config.samples == 10
    assert config.rpc_url == "https://test.rpc"


def test_load_cfg_missing_required_field_raises_error() -> None:
    """Config parsing raises ValueError for missing required fields."""
    raw = {
        "corpus_root": "/corpus",
        # Missing samples
    }

    with pytest.raises(ValueError) as exc_info:
        _load_cfg(raw)

    assert "missing" in str(exc_info.value).lower()


def test_load_cfg_extra_ignored() -> None:
    """Config parsing ignores extra fields."""
    raw = {
        "corpus_root": "/corpus",
        "package_ids_file": "/manifest.txt",
        "samples": 10,
        "extra_field": "ignored",
        "another_extra": 42,
    }

    config = _load_cfg(raw)

    assert config.corpus_root == "/corpus"
    assert config.samples == 10


def test_safe_int_valid_value_returns_int() -> None:
    """Type conversion returns int for valid inputs."""
    assert _safe_int("42", 0) == 42
    assert _safe_int(42.5, 0) == 42
    assert _safe_int(0, 0) == 0
    assert _safe_int(-10, 0) == -10
    assert _safe_int(" 42  ", 0) == 42


def test_safe_int_invalid_value_returns_default() -> None:
    """Type conversion uses default for invalid inputs."""
    assert _safe_int(None, 5) == 5
    assert _safe_int("not_a_number", 5) == 5
    assert _safe_int("", 5) == 5
    assert _safe_int([1, 2, 3], 5) == 5


def test_safe_float_valid_value_returns_float() -> None:
    """Type conversion returns float for valid inputs."""
    assert _safe_float("42.5", 0.0) == 42.5
    assert _safe_float(42, 0.0) == 42.0
    assert _safe_float(0.0, 0.0) == 0.0
    assert _safe_float(-10.5, 0.0) == -10.5


def test_safe_float_invalid_value_returns_default() -> None:
    """Type conversion uses default for invalid inputs."""
    assert _safe_float(None, 0.0) == 0.0
    assert _safe_float("not_a_number", 0.0) == 0.0
    assert _safe_float("", 0.0) == 0.0
    assert _safe_float([1, 2, 3], 0.0) == 0.0


def test_extract_payload_parses_context() -> None:
    """Payload extraction parses context from Request."""
    from a2a.types import TaskContext, TextPart

    context = MagicMock(spec=TaskContext)
    context.get_user_input.return_value = json.dumps({"corpus_root": "/test"})

    payload = _extract_payload(context)

    assert "corpus_root" in payload
    assert payload["corpus_root"] == "/test"


def test_extract_payload_missing_parts_returns_empty_dict() -> None:
    """Payload extraction handles no parts gracefully."""
    from a2a.types import TaskContext

    context = MagicMock(spec=TaskContext)
    context.get_user_input.return_value = None  # No user input

    # _extract_payload handles missing parts internally
    payload = _extract_payload(context)

    # Should return empty dict when no parts (implementation detail)
    assert isinstance(payload, dict)


def test_card_returns_valid_agentcard() -> None:
    """Agent card creation returns valid AgentCard."""
    from a2a.types import AgentCard

    card = _card(url="http://test.url")

    assert isinstance(card, AgentCard)
    # Verify required fields
    # The card name is generated by _card function
    assert card.version is not None
